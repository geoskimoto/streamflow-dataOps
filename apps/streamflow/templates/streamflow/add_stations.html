{% extends 'base.html' %}
{% load crispy_forms_tags %}

{% block title %}Add Stations - {{ configuration.name }}{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-md-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'streamflow:configuration_list' %}">Configurations</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'streamflow:configuration_detail' configuration.pk %}">{{ configuration.name }}</a></li>
                    <li class="breadcrumb-item active">Add Stations</li>
                </ol>
            </nav>
        </div>
    </div>

    <div class="row">
        <div class="col-md-12">
            <h2>Add Stations to "{{ configuration.name }}"</h2>
            <p class="text-muted">Search and select stations from the master list to add to this configuration.</p>
        </div>
    </div>

    <div class="row mt-4">
        <!-- Filters -->
        <div class="col-md-3">
            <div class="card">
                <div class="card-header">
                    <h5>Filters</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="stateFilter" class="form-label">State</label>
                        <select class="form-select" id="stateFilter">
                            <option value="">All States</option>
                            {% for state in states %}
                            <option value="{{ state }}">{{ state }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="hucFilter" class="form-label">HUC Code</label>
                        <input type="text" class="form-control" id="hucFilter" placeholder="e.g., 02070010">
                        <small class="text-muted">Enter partial HUC to filter</small>
                    </div>
                    
                    <div class="mb-3">
                        <label for="searchBox" class="form-label">Search</label>
                        <input type="text" class="form-control" id="searchBox" placeholder="Station ID or name...">
                    </div>
                    
                    <button class="btn btn-primary w-100" id="applyFilters">Apply Filters</button>
                    <button class="btn btn-secondary w-100 mt-2" id="clearFilters">Clear Filters</button>
                </div>
            </div>

            <div class="card mt-3">
                <div class="card-header">
                    <h5>Selected Stations</h5>
                </div>
                <div class="card-body">
                    <p id="selectedCount" class="mb-2"><strong>0</strong> stations selected</p>
                    <form method="post" id="addStationsForm">
                        {% csrf_token %}
                        <div id="selectedStationsList"></div>
                        <button type="submit" class="btn btn-success w-100 mt-3" id="addStationsBtn" disabled>
                            Add Selected Stations
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Station List -->
        <div class="col-md-9">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Available Stations</h5>
                    <button class="btn btn-sm btn-outline-secondary" id="selectAllBtn">Select All</button>
                </div>
                <div class="card-body">
                    <div id="loadingIndicator" class="text-center d-none">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p>Loading stations...</p>
                    </div>
                    
                    <div id="stationResults">
                        <p class="text-muted">Use the filters to search for stations.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.station-item {
    border: 1px solid #ddd;
    border-radius: 4px;
    padding: 10px;
    margin-bottom: 10px;
    cursor: pointer;
    transition: all 0.2s;
}

.station-item:hover {
    background-color: #f8f9fa;
    border-color: #0d6efd;
}

.station-item.selected {
    background-color: #e7f3ff;
    border-color: #0d6efd;
}

.station-item.disabled {
    opacity: 0.5;
    cursor: not-allowed;
    background-color: #f1f1f1;
}

.station-item.disabled:hover {
    border-color: #ddd;
}

.selected-station-badge {
    display: inline-block;
    padding: 5px 10px;
    margin: 5px;
    background-color: #0d6efd;
    color: white;
    border-radius: 4px;
    font-size: 0.9em;
}

.selected-station-badge .remove-btn {
    margin-left: 5px;
    cursor: pointer;
    font-weight: bold;
}
</style>

<script>
let selectedStations = new Set();
const currentStations = {{ current_station_numbers|safe }};

function updateSelectedCount() {
    const count = selectedStations.size;
    document.getElementById('selectedCount').innerHTML = `<strong>${count}</strong> stations selected`;
    document.getElementById('addStationsBtn').disabled = count === 0;
    
    // Update selected stations list
    const listDiv = document.getElementById('selectedStationsList');
    listDiv.innerHTML = '';
    
    selectedStations.forEach(stationId => {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'station_ids';
        input.value = stationId;
        listDiv.appendChild(input);
        
        // Find station data
        const stationDiv = document.querySelector(`[data-station-id="${stationId}"]`);
        if (stationDiv) {
            const stationNumber = stationDiv.querySelector('.station-number').textContent;
            const badge = document.createElement('div');
            badge.className = 'selected-station-badge';
            badge.innerHTML = `${stationNumber} <span class="remove-btn" data-station-id="${stationId}">&times;</span>`;
            listDiv.appendChild(badge);
        }
    });
}

function loadStations() {
    const state = document.getElementById('stateFilter').value;
    const huc = document.getElementById('hucFilter').value;
    const search = document.getElementById('searchBox').value;
    
    // Show loading
    document.getElementById('loadingIndicator').classList.remove('d-none');
    document.getElementById('stationResults').innerHTML = '';
    
    // Build query
    const params = new URLSearchParams();
    if (state) params.append('state', state);
    if (huc) params.append('huc', huc);
    if (search) params.append('q', search);
    params.append('limit', '100');
    
    fetch(`{% url 'streamflow:station_search_ajax' %}?${params.toString()}`)
        .then(response => response.json())
        .then(data => {
            document.getElementById('loadingIndicator').classList.add('d-none');
            
            if (data.stations.length === 0) {
                document.getElementById('stationResults').innerHTML = '<p class="text-muted">No stations found.</p>';
                return;
            }
            
            const resultsDiv = document.getElementById('stationResults');
            resultsDiv.innerHTML = '';
            
            data.stations.forEach(station => {
                const isCurrentStation = currentStations.includes(station.station_number);
                const isSelected = selectedStations.has(station.id.toString());
                
                const div = document.createElement('div');
                div.className = 'station-item';
                div.dataset.stationId = station.id;
                
                if (isCurrentStation) {
                    div.classList.add('disabled');
                }
                if (isSelected) {
                    div.classList.add('selected');
                }
                
                div.innerHTML = `
                    <div class="d-flex justify-content-between">
                        <div>
                            <strong class="station-number">${station.station_number}</strong>
                            ${isCurrentStation ? '<span class="badge bg-secondary ms-2">Already Added</span>' : ''}
                            ${isSelected ? '<span class="badge bg-primary ms-2">Selected</span>' : ''}
                        </div>
                        <div class="text-muted">
                            <small>${station.state_code || ''} ${station.huc_code || ''}</small>
                        </div>
                    </div>
                    <div class="text-muted">${station.station_name}</div>
                `;
                
                if (!isCurrentStation) {
                    div.addEventListener('click', () => {
                        if (selectedStations.has(station.id.toString())) {
                            selectedStations.delete(station.id.toString());
                            div.classList.remove('selected');
                        } else {
                            selectedStations.add(station.id.toString());
                            div.classList.add('selected');
                        }
                        updateSelectedCount();
                    });
                }
                
                resultsDiv.appendChild(div);
            });
        })
        .catch(error => {
            document.getElementById('loadingIndicator').classList.add('d-none');
            document.getElementById('stationResults').innerHTML = '<p class="text-danger">Error loading stations.</p>';
            console.error('Error:', error);
        });
}

// Event listeners
document.getElementById('applyFilters').addEventListener('click', loadStations);
document.getElementById('clearFilters').addEventListener('click', () => {
    document.getElementById('stateFilter').value = '';
    document.getElementById('hucFilter').value = '';
    document.getElementById('searchBox').value = '';
    document.getElementById('stationResults').innerHTML = '<p class="text-muted">Use the filters to search for stations.</p>';
});

document.getElementById('selectAllBtn').addEventListener('click', () => {
    document.querySelectorAll('.station-item:not(.disabled)').forEach(div => {
        const stationId = div.dataset.stationId;
        if (!selectedStations.has(stationId)) {
            selectedStations.add(stationId);
            div.classList.add('selected');
        }
    });
    updateSelectedCount();
});

// Handle remove from selected list
document.getElementById('selectedStationsList').addEventListener('click', (e) => {
    if (e.target.classList.contains('remove-btn')) {
        const stationId = e.target.dataset.stationId;
        selectedStations.delete(stationId);
        
        // Update visual state in results
        const stationDiv = document.querySelector(`[data-station-id="${stationId}"]`);
        if (stationDiv) {
            stationDiv.classList.remove('selected');
        }
        
        updateSelectedCount();
    }
});

// Allow Enter key to search
document.getElementById('searchBox').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
        e.preventDefault();
        loadStations();
    }
});

// Initialize
updateSelectedCount();
</script>
{% endblock %}
